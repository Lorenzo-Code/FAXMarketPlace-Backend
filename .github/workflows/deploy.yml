# File: .github/workflows/deploy.yml

name: Deploy to Droplet

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: SSH into Droplet and Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: root
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script: |
            # Handle repository name change
            if [ -d "/root/FractionaX-Backend" ]; then
              cd /root/FractionaX-Backend
            elif [ -d "/root/FAXMarketPlace-Backend" ]; then
              cd /root/FAXMarketPlace-Backend
              # Update remote URL to new repository name
              git remote set-url origin https://github.com/Lorenzo-Code/FractionaX-Backend.git
            else
              # Clone the repository if it doesn't exist
              git clone https://github.com/Lorenzo-Code/FractionaX-Backend.git /root/FractionaX-Backend
              cd /root/FractionaX-Backend
            fi
            git pull origin main
            # Stop and remove any existing containers using port 8000
            docker ps -q --filter "publish=8000" | xargs -r docker stop
            docker ps -aq --filter "publish=8000" | xargs -r docker rm
            # Also try to remove containers by name (in case they exist but not running)
            docker rm -f fax-api || true
            # Clean up old images to free space
            docker image prune -f
            # Build and run new container
            docker build -t fax-backend .
            docker run -d --env-file .env -p 8000:8000 --name fax-api fax-backend
